# piring
**Control a school sound system from a Raspberry Pi with touchscreen**

## Usage
`ring`

## Hardware
Pi with 3.5" 480x320 touchscreen and a relay that controls the
power to the amplifier, and a audio lead from the pi's output to the
amplifier's input, so that apart from ringing the various school bells,
alarms can be sounded and announcements can be made.

## Function
The Normal schedule will ring on every weekday, unless that day is
marked as a No-Bells day. Special schedules will always ring on any
scheduled day, but the Normal schedule will be cancelled, unless at least
one of the Special schedules is an Additional schedule (having a `+` after
the date in $ringdates). The (optional) file $ringdates determines the
dates for the Special and Additional schedules and the No-Bells days (by
default Saturdays & Sundays).
The time schedules are defined in the file $ringtimes.
The touchscreen can be used to turn on the amplifier to make an
announcement or (optionally) play (alarm) sound files.
- The input files $ringdates and $ringtimes are read from the same directory as where the $ring script resides, the $buttons script is in directory $ts together with all images that are part of it, and the sound files reside in directory $sf.
- The input files $ringtimes and $ringdates are read and checked for proper syntax & semantics.
- The ringtone sound files referenced in $ringtimes are symlinks `R.ring` in where `R` is the digit referenced (`0` is the default ringtone); when referenced they need to be present in $sf.
- The optional (alarm)button sound files are symlinks `B.alarm` (B:1..4) which are played when the corresponding touchscreen buttons are selected.
- The temporary file $buttonfile also resides in $ts and it is used to pass touchscreen state that is generated by the python script $buttons that is started from the $ring script.
- When all is in order the program starts and output is logged to stdout.

### Format inputfiles
- All lines starting with `#` as the first character are skipped as comments.
- $ringtimes: lines with `HH:MMsR` where `s` is Schedule (Normal schedule is space/empty, and Special schedule codes have an alphabetic character) and `R` is the numerical single digit Ringtone code. If `R` is space/empty it references the default ringtone file `0.ring`. If `R` is `-` it means that time slot is muted regardless of any other schedules. In general, the `R` refers to the ringtone file `R.ring`. All characters after position 7 are ignored as a comment.
- $ringdates (optional): lines of `YYYY-MM-DDis` or `YYYY-MM-DD/YYYY-MM-DDis` where `s` is either space/empty (for No-Bells dates) or the alphabetical Special schedule code. The `i` can be empty/space or `+` (means in addition to the Normal schedule, otherwise the Normal schedule is replaced by the Special schedule). The double date format is the beginning and end of an inclusive date range. There can be multiple Special schedules for the same date, and all get rung (even if that date is also a No-Bells date!). All characters after position 12 resp. 23 are ignored as a comment.

## Required
wiringpi(gpio) coreutils(sleep fold readlink) sox(play) date
[$buttons: python2.7 pygame] [`rc.local`: tmux(optional)]

## Deployment
To autostart on reboot, source the script `rc.local`. There are two
deployment examples given there.

## License
GPLv3+  https://spdx.org/licenses/GPL-3.0-or-later.html
